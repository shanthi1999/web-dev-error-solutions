name: ðŸ“ Generate Error Documentation from Issues

on:
  issues:
    types: [opened]

permissions:
  contents: write  # âœ… Needed for git push

jobs:
  generate-doc:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up GitHub Actions as user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Detect topic from issue body
        id: topic
        run: |
          BODY="${{ github.event.issue.body }}"
          BODY_LOWER=$(echo "$BODY" | tr '[:upper:]' '[:lower:]')
          if echo "$BODY_LOWER" | grep -q "javascript"; then
            echo "topic=javascript" >> $GITHUB_OUTPUT
          elif echo "$BODY_LOWER" | grep -q "css"; then
            echo "topic=css" >> $GITHUB_OUTPUT
          elif echo "$BODY_LOWER" | grep -q "react"; then
            echo "topic=react" >> $GITHUB_OUTPUT
          elif echo "$BODY_LOWER" | grep -q "jquery"; then
            echo "topic=jquery" >> $GITHUB_OUTPUT
          else
            echo "topic=general" >> $GITHUB_OUTPUT
          fi

      - name: Sanitize folder name from issue title
        id: folder
        run: |
          FOLDER=$(echo "${{ github.event.issue.title }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
          echo "folder=$FOLDER" >> $GITHUB_OUTPUT

      - name: Create README.md from issue
        run: |
          mkdir -p "errors/${{ steps.topic.outputs.topic }}/${{ steps.folder.outputs.folder }}"
          echo "# ðŸž ${{ github.event.issue.title }}" > "errors/${{ steps.topic.outputs.topic }}/${{ steps.folder.outputs.folder }}/README.md"
          echo "" >> "errors/${{ steps.topic.outputs.topic }}/${{ steps.folder.outputs.folder }}/README.md"
          echo "${{ github.event.issue.body }}" >> "errors/${{ steps.topic.outputs.topic }}/${{ steps.folder.outputs.folder }}/README.md"

      - name: Commit and push
        run: |
          git add .
          git commit -m "ðŸ“š Add error doc: ${{ github.event.issue.title }}" || echo "Nothing to commit"
          git push
